/*
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */

#import "RCTSafeAreaViewComponentView.h"

#import <React/RCTUtils.h>
<<<<<<< HEAD
#import <react/components/safeareaview/SafeAreaViewComponentDescriptor.h>
#import <react/components/safeareaview/SafeAreaViewState.h>
#import "FBRCTFabricComponentsPlugins.h"
=======
#import <react/renderer/components/safeareaview/SafeAreaViewComponentDescriptor.h>
#import <react/renderer/components/safeareaview/SafeAreaViewState.h>
>>>>>>> e75a71e2c6ac3e5d484a463ebda2ebf8c6ccb707
#import "RCTConversions.h"
#import "RCTFabricComponentsPlugins.h"

using namespace facebook::react;

@implementation RCTSafeAreaViewComponentView {
<<<<<<< HEAD
  SafeAreaViewShadowNode::ConcreteState::Shared _state;
=======
  SafeAreaViewShadowNode::ConcreteStateTeller _stateTeller;
  EdgeInsets _lastPaddingStateWasUpdatedWith;
>>>>>>> e75a71e2c6ac3e5d484a463ebda2ebf8c6ccb707
}

- (instancetype)initWithFrame:(CGRect)frame
{
  if (self = [super initWithFrame:frame]) {
    static auto const defaultProps = std::make_shared<SafeAreaViewProps const>();
    _props = defaultProps;
    self.clipsToBounds = YES;
  }

  return self;
}

- (UIEdgeInsets)_safeAreaInsets
{
<<<<<<< HEAD
  if (@available(iOS 11.0, tvOS 11.0, *)) {
=======
  if (@available(iOS 11.0, *)) {
>>>>>>> e75a71e2c6ac3e5d484a463ebda2ebf8c6ccb707
    return self.safeAreaInsets;
  }

  return UIEdgeInsetsZero;
}

<<<<<<< HEAD
- (void)layoutSubviews
{
  [super layoutSubviews];
}

=======
>>>>>>> e75a71e2c6ac3e5d484a463ebda2ebf8c6ccb707
- (void)safeAreaInsetsDidChange
{
  [super safeAreaInsetsDidChange];

  [self _updateStateIfNecessary];
}

- (void)_updateStateIfNecessary
{
<<<<<<< HEAD
  if (!_state) {
    return;
  }

=======
>>>>>>> e75a71e2c6ac3e5d484a463ebda2ebf8c6ccb707
  UIEdgeInsets insets = [self _safeAreaInsets];
  insets.left = RCTRoundPixelValue(insets.left);
  insets.top = RCTRoundPixelValue(insets.top);
  insets.right = RCTRoundPixelValue(insets.right);
  insets.bottom = RCTRoundPixelValue(insets.bottom);

<<<<<<< HEAD
  auto oldPadding = _state->getData().padding;
  auto newPadding = RCTEdgeInsetsFromUIEdgeInsets(insets);
  auto threshold = 1.0 / RCTScreenScale() + 0.01; // Size of a pixel plus some small threshold.
  auto deltaPadding = newPadding - oldPadding;
=======
  auto newPadding = RCTEdgeInsetsFromUIEdgeInsets(insets);
  auto threshold = 1.0 / RCTScreenScale() + 0.01; // Size of a pixel plus some small threshold.
  auto deltaPadding = newPadding - _lastPaddingStateWasUpdatedWith;
>>>>>>> e75a71e2c6ac3e5d484a463ebda2ebf8c6ccb707

  if (std::abs(deltaPadding.left) < threshold && std::abs(deltaPadding.top) < threshold &&
      std::abs(deltaPadding.right) < threshold && std::abs(deltaPadding.bottom) < threshold) {
    return;
  }

<<<<<<< HEAD
  _state->updateState(SafeAreaViewState{newPadding});
=======
  _lastPaddingStateWasUpdatedWith = newPadding;
  _stateTeller.updateState(SafeAreaViewState{newPadding});
>>>>>>> e75a71e2c6ac3e5d484a463ebda2ebf8c6ccb707
}

#pragma mark - RCTComponentViewProtocol

<<<<<<< HEAD
- (void)updateState:(facebook::react::State::Shared const &)state
           oldState:(facebook::react::State::Shared const &)oldState
{
  _state = std::static_pointer_cast<SafeAreaViewShadowNode::ConcreteState const>(state);
  [self _updateStateIfNecessary];
}

=======
- (void)updateState:(State::Shared const &)state oldState:(State::Shared const &)oldState
{
  _stateTeller.setConcreteState(state);
  [self _updateStateIfNecessary];
}

- (void)prepareForRecycle
{
  [super prepareForRecycle];
  _stateTeller.invalidate();
  _lastPaddingStateWasUpdatedWith = {};
}

>>>>>>> e75a71e2c6ac3e5d484a463ebda2ebf8c6ccb707
+ (ComponentDescriptorProvider)componentDescriptorProvider
{
  return concreteComponentDescriptorProvider<SafeAreaViewComponentDescriptor>();
}

@end

Class<RCTComponentViewProtocol> RCTSafeAreaViewCls(void)
{
  return RCTSafeAreaViewComponentView.class;
}
